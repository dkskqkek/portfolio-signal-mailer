//@version=5
strategy("Antigravity V4.1 [Live Engine]", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, currency=currency.USD)

// ==========================================
// 0. ìŠ¤í¬ë¦½íŠ¸ ê°œìš”
// ==========================================
// ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” Antigravity V4.1ì˜ íŒŒì´ì¬ ë¡œì§ì„ íŠ¸ë ˆì´ë”©ë·°ìš©ìœ¼ë¡œ ë³€í™˜í•œ ê²ƒì…ë‹ˆë‹¤.
// 1. ì¶”ì„¸ ì¶”ì¢… (Trend Following): QQQê°€ 110ì¼/250ì¼ ì´í‰ì„  ìœ„ì— ìˆì„ ë•Œ ìƒìŠ¹ì¥(Bull)ìœ¼ë¡œ ê°„ì£¼
// 2. ë°©ì–´ ìì‚° (Defensive): í•˜ë½ì¥ì¼ ê²½ìš°, ëª¨ë©˜í…€ì´ ê°€ì¥ ì¢‹ì€ ë°©ì–´ ìì‚°(GLD, TLT, í˜„ê¸ˆ ë“±)ìœ¼ë¡œ í”¼ì‹ 
// 3. ì¸ë±ìŠ¤ ìŠ¤ë‚˜ì´í¼ (Index Sniper): ê³µí¬ ì§€ìˆ˜(VIX Fix)ë¥¼ ì‹œê°í™”í•˜ì—¬ ë‹¨ê¸° ì €ì  í¬ì°©

// ==========================================
// 1. ì‚¬ìš©ì ì…ë ¥ (User Inputs)
// ==========================================
grp_asset   = "ìì‚° ì„¤ì •"
t_growth    = input.symbol("QQQ", "ê³µê²© ìì‚° (Growth)", group=grp_asset)
t_lev       = input.symbol("QLD", "ë ˆë²„ë¦¬ì§€ ìì‚° (Bull Mode)", group=grp_asset)
t_def1      = input.symbol("GLD", "ë°©ì–´ ìì‚° í›„ë³´ 1 (ê³¨ë“œ)", group=grp_asset)
t_def2      = input.symbol("TLT", "ë°©ì–´ ìì‚° í›„ë³´ 2 (ë¯¸êµ­ì±„)", group=grp_asset)
t_def3      = input.symbol("BIL", "ë°©ì–´ ìì‚° í›„ë³´ 3 (í˜„ê¸ˆì„±)", group=grp_asset)

grp_trend   = "ì¶”ì„¸ ì„¤ì • (Daily)"
len_ma1     = input.int(110, "ë‹¨ê¸° ì´ë™í‰ê·  (SMA 110)", group=grp_trend)
len_ma2     = input.int(250, "ì¥ê¸° ì´ë™í‰ê·  (SMA 250)", group=grp_trend)
mom_month   = input.int(8, "ëª¨ë©˜í…€ ì‚°ì¶œ ê¸°ê°„ (ì›”)", group=grp_trend)

grp_sniper  = "ì¸ë±ìŠ¤ ìŠ¤ë‚˜ì´í¼ ì„¤ì • (V8.2)"
show_sniper = input.bool(true, "ìŠ¤ë‚˜ì´í¼ ê³µí¬ êµ¬ê°„ í‘œì‹œ", group=grp_sniper)
pd_lookback = input.int(22, "VIX Fix ê¸°ê°„", group=grp_sniper)
bbl         = input.int(20, "ë³¼ë¦°ì € ë°´ë“œ ê¸¸ì´", group=grp_sniper)
mult        = input.float(2.0, "ë³¼ë¦°ì € ë°´ë“œ ìŠ¹ìˆ˜", group=grp_sniper)
lb          = input.int(50, "ìµœëŒ€ ê³µí¬ ë¹„êµ ê¸°ê°„", group=grp_sniper)

// ==========================================
// 2. ë°ì´í„° ê³„ì‚° (Calculations)
// ==========================================
// QQQ ë°ì´í„° í˜¸ì¶œ (ì¼ë´‰ ê¸°ì¤€)
qqq_close = request.security(t_growth, "D", close)
sma110    = ta.sma(qqq_close, len_ma1)
sma250    = ta.sma(qqq_close, len_ma2)

// ==========================================
// 3. ì‹ í˜¸ ë¡œì§ (Signal Logic)
// ==========================================
// 3.1 ì¶”ì„¸ íŒë‹¨ (Daily Trend)
// ê·œì¹™: ê°€ê²©ì´ ë‘ ì´í‰ì„ (110, 250) ìœ„ì— ìˆì–´ì•¼ ìƒìŠ¹ì¥(BULL)
is_bull = (qqq_close > sma110) and (qqq_close > sma250)

// 3.2 ë°©ì–´ ìì‚° ì„ ì • (Monthly Momentum)
// ì¤‘ìš”: 'ì§€ë‚œë‹¬ ë§ì¼' ê¸°ì¤€ì˜ ëª¨ë©˜í…€ì„ ì‚¬ìš©í•´ì•¼ ë¦¬í˜ì¸íŒ…(Repainting)ì´ ì—†ìŒ
// [1]ì€ í˜„ì¬ ì›” ë°”ë¡œ ì§ì „ ì›”ì˜ í™•ì •ëœ ë°ì´í„°ë¥¼ ì˜ë¯¸í•¨
calc_mom(sym) =>
    float p_last = request.security(sym, "M", close[1])       // ì „ì›” ì¢…ê°€ (ê¸°ì¤€)
    float p_past = request.security(sym, "M", close[1 + mom_month]) // (1+8)ê°œì›” ì „ ì¢…ê°€
    (p_last - p_past) / p_past

mom1 = calc_mom(t_def1)
mom2 = calc_mom(t_def2)
mom3 = calc_mom(t_def3)

// 3.3 ìµœì  ë°©ì–´ ìì‚° ê²°ì • (Top 1)
// ê°€ì¥ ëª¨ë©˜í…€ì´ ë†’ì€ ìì‚°ì„ ì„ íƒ
best_def_ticker = t_def1
best_mom = mom1

if mom2 > best_mom
    best_def_ticker := t_def2
    best_mom := mom2

if mom3 > best_mom
    best_def_ticker := t_def3
    best_mom := mom3

// ==========================================
// 4. ì¸ë±ìŠ¤ ìŠ¤ë‚˜ì´í¼ (Index Sniper V8.2)
// ==========================================
// ê³µí¬ ì§€ìˆ˜ (Williams VIX Fix) ê³„ì‚°
wvf = ((ta.highest(close, pd_lookback) - low) / ta.highest(close, pd_lookback)) * 100

// ë³¼ë¦°ì € ë°´ë“œ ê³„ì‚°
s_mid = ta.sma(wvf, bbl)
s_dev = mult * ta.stdev(wvf, bbl)
s_upper = s_mid + s_dev
range_high = ta.highest(wvf, lb) * 0.85

// ê³µí¬ êµ¬ê°„ íŒë³„ (ë°´ë“œ ìƒë‹¨ ëŒíŒŒ ë˜ëŠ” ìµœê³ ì  ê·¼ì ‘)
is_fear = (wvf >= s_upper) or (wvf >= range_high)

// ë°°ê²½ìƒ‰ í‘œì‹œ (ìŠ¤ë‚˜ì´í¼ ê¸°ëŠ¥)
bgcolor(show_sniper and is_fear ? color.new(color.red, 90) : na, title="ê³µí¬ êµ¬ê°„ (Fear Zone)")

// ==========================================
// 5. ì „ëµ ì‹¤í–‰ (Strategy Execution)
// ==========================================
// *ì£¼ì˜: íŠ¸ë ˆì´ë”©ë·° ì „ëµ ìŠ¤í¬ë¦½íŠ¸ëŠ” í˜„ì¬ ì°¨íŠ¸ì˜ ì‹¬ë³¼ í•˜ë‚˜ë§Œ ë§¤ë§¤í•˜ëŠ” ê²ƒì´ ê¸°ë³¸ì…ë‹ˆë‹¤.*
// *ë”°ë¼ì„œ ì„œë¡œ ë‹¤ë¥¸ ìì‚°(GLD, TLT ë“±)ìœ¼ë¡œ ê°ˆì•„íƒ€ëŠ” ë¡œì§ì€ ë°±í…ŒìŠ¤íŠ¸ ìˆ˜ìµë¥ ì— ì •í™•íˆ ë°˜ì˜ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.*
// *ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì •í™•í•œ 'ì‹ í˜¸ ë°œìƒ(Alert)'ì— ì´ˆì ì„ ë§ì¶¥ë‹ˆë‹¤.*

if is_bull
    // [ìƒìŠ¹ì¥] ë ˆë²„ë¦¬ì§€ ìì‚°(QLD) ë§¤ìˆ˜
    strategy.close("Defensive") // ë°©ì–´ í¬ì§€ì…˜ ì¢…ë£Œ
    strategy.entry("Growth_Buy", strategy.long, comment="ğŸš€ ìƒìŠ¹ì¥(Bull): " + str.tostring(t_lev))
else
    // [í•˜ë½ì¥] ë°©ì–´ ìì‚° ë§¤ìˆ˜
    strategy.close("Growth_Buy") // ê³µê²© í¬ì§€ì…˜ ì¢…ë£Œ
    
    // ì„ íƒëœ ë°©ì–´ ìì‚° ì´ë¦„ìœ¼ë¡œ ì§„ì… í‘œì‹œ
    // (ì‹¤ì œë¡œëŠ” í˜„ì¬ ì°¨íŠ¸ ì¢…ëª©ì„ ë§¤ìˆ˜/ë§¤ë„ í•˜ë¯€ë¡œ ì‹œë®¬ë ˆì´ì…˜ í•œê³„ ì¡´ì¬)
    strategy.entry("Defensive", strategy.long, comment="ğŸ›¡ï¸ ë°©ì–´ íƒœì„¸: " + str.tostring(best_def_ticker))

// ==========================================
// 6. ì°¨íŠ¸ ì‹œê°í™” (Visuals)
// ==========================================
// ì´í‰ì„  ê·¸ë¦¬ê¸°
plot(sma110, "ë‹¨ê¸° ì´í‰ (110)", color=color.green, linewidth=2)
plot(sma250, "ì¥ê¸° ì´í‰ (250)", color=color.orange, linewidth=2)

// ìƒíƒœ ì •ë³´ íŒ¨ë„ (ìš°ì¸¡ ìƒë‹¨ ë¼ë²¨)
var label status_lbl = na
label.delete(status_lbl) // ì´ì „ ë¼ë²¨ ì‚­ì œ

// í…ìŠ¤íŠ¸ êµ¬ì„±
status_text = is_bull ? "ğŸš€ ìƒìŠ¹ì¥ (BULL)\në³´ìœ : " + str.tostring(t_lev) : "ğŸ›¡ï¸ ë°©ì–´ì¥ (DEFENSIVE)\nì„ íƒ: " + str.tostring(best_def_ticker)
status_color = is_bull ? color.green : color.red // textcolor=color.white

// ë¼ë²¨ ìƒì„± (ìµœì‹  ë°” ìœ„ì— í‘œì‹œ)
status_lbl := label.new(bar_index, high + ta.tr, text=status_text, color=status_color, textcolor=color.white, style=label.style_label_down)

// ìŠ¤ë‚˜ì´í¼ ë§¤ìˆ˜ ì‹ í˜¸ (ê³µí¬ êµ¬ê°„) ì‚¼ê°í˜• í‘œì‹œ
plotshape(show_sniper and is_fear, title="ê³µí¬ ë§¤ìˆ˜ ê¸°íšŒ", style=shape.triangleup, location=location.belowbar, color=color.red, size=size.small, text="ê³µí¬")
